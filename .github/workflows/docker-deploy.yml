name: Docker Build and Deploy to ARM Server

on:
  push:
    tags:
      - 'v*.*.*'  # v1.0.0, v1.2.3 ÌòïÏãùÏùò ÌÉúÍ∑∏
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"

          # CHANGELOG.mdÍ∞Ä ÏûàÏúºÎ©¥ Ìï¥Îãπ Î≤ÑÏ†ÑÏùò ÎÇ¥Ïö© Ï∂îÏ∂ú
          if [ -f "CHANGELOG.md" ] && grep -q "## \[$VERSION\]" CHANGELOG.md; then
            CHANGELOG=$(sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '$d' | tail -n +2)
          else
            CHANGELOG="Î¶¥Î¶¨Ïä§ ÎÖ∏Ìä∏Îäî CHANGELOG.mdÎ•º Ï∞∏Ï°∞ÌïòÏÑ∏Ïöî."
          fi

          # GitHub OutputÏúºÎ°ú ÏÑ§Ï†ï
          echo "NOTES<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.version }}
          body: |
            ## üöÄ Î¶¥Î¶¨Ïä§ ÎÖ∏Ìä∏

            ${{ steps.changelog.outputs.NOTES }}

            ---

            **Î∞∞Ìè¨ Ï†ïÎ≥¥**
            - Î≤ÑÏ†Ñ: ${{ steps.version.outputs.version }}
            - ÌîåÎû´Ìèº: ARM64
            - Ïª®ÌÖåÏù¥ÎÑà: cheftory-homepage

            **Ï†ÑÏ≤¥ Î≥ÄÍ≤ΩÏÇ¨Ìï≠**: [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
          draft: false
          prerelease: false
          generate_release_notes: true

  build-and-deploy:
    needs: create-release
    runs-on: self-hosted  # Runner ÏÑúÎ≤ÑÏóêÏÑú ÎπåÎìú

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Build Docker image
        timeout-minutes: 20
        run: |
          docker build \
            --build-arg VITE_GA_MEASUREMENT_ID=${{ secrets.VITE_GA_MEASUREMENT_ID }} \
            -t cheftory-homepage:latest .

      - name: Save Docker image to tar
        run: |
          docker save cheftory-homepage:latest -o cheftory-homepage.tar

      - name: Check tar file size
        run: |
          ls -lh cheftory-homepage.tar
          echo "Image size: $(du -h cheftory-homepage.tar | cut -f1)"

      - name: Transfer Docker image to deployment server
        run: |
          scp -P ${{ secrets.DEPLOY_SERVER_PORT }} \
            cheftory-homepage.tar \
            ${{ secrets.DEPLOY_SERVER_USER }}@${{ secrets.DEPLOY_SERVER_HOST }}:/home/filient/docker/cheftory_homepage/

      - name: Transfer docker-compose.yml
        run: |
          scp -P ${{ secrets.DEPLOY_SERVER_PORT }} \
            docker-compose.yml \
            ${{ secrets.DEPLOY_SERVER_USER }}@${{ secrets.DEPLOY_SERVER_HOST }}:/home/filient/docker/cheftory_homepage/

      - name: Deploy on deployment server
        run: |
          ssh -p ${{ secrets.DEPLOY_SERVER_PORT }} \
            ${{ secrets.DEPLOY_SERVER_USER }}@${{ secrets.DEPLOY_SERVER_HOST }} << 'EOF'
            cd /home/filient/docker/cheftory_homepage

            # Docker Ïù¥ÎØ∏ÏßÄ Î°úÎìú
            echo "Loading Docker image..."
            docker load -i cheftory-homepage.tar

            # Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà Ï§ëÏßÄ Î∞è Ï†úÍ±∞
            echo "Stopping existing container..."
            docker compose down || true

            # ÏÉà Ïª®ÌÖåÏù¥ÎÑà ÏãúÏûë
            echo "Starting new container..."
            docker compose up -d

            # Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú ÌôïÏù∏
            echo "Checking container status..."
            docker compose ps

            # cheftory-homepageÏùò Ïò§ÎûòÎêú Ïù¥ÎØ∏ÏßÄÎßå Ï†ïÎ¶¨
            echo "Cleaning up old cheftory-homepage images..."
            docker images | grep cheftory-homepage | grep "<none>" | awk '{print $3}' | xargs -r docker rmi || true

            # tar ÌååÏùº ÏÇ≠Ï†ú
            echo "Removing tar file..."
            rm -f cheftory-homepage.tar

            # Health check
            echo "Verifying deployment..."
            sleep 5
            curl -f http://localhost:3001/health || exit 1

            echo "Deployment completed successfully!"
          EOF

      - name: Cleanup local tar file
        if: always()
        run: |
          rm -f cheftory-homepage.tar

      - name: Deployment summary
        if: success()
        run: |
          echo "‚úÖ Deployment successful!"
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "Deployment server: ${{ secrets.DEPLOY_SERVER_HOST }}"
          echo "Container: cheftory-homepage"
